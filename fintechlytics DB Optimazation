-- Indexing for Performance
-- Apply appropriate indexes to all foreign key columns
-- Transactions table foreign keys
CREATE INDEX idx_transactions_user_id ON transactions(user_id);
CREATE INDEX idx_transactions_stock_id ON transactions(stock_id);

-- StockPrices table foreign key
CREATE INDEX idx_stock_prices_stock_id ON stock_prices(stock_id);

-- Portfolios table foreign keys
CREATE INDEX idx_portfolios_user_id ON portfolios(user_id);
CREATE INDEX idx_portfolios_stock_id ON portfolios(stock_id);

-- Add Composite Index on (stock_id, timestamp) for Time-Series Optimization
CREATE INDEX idx_stock_prices_stock_time ON stock_prices(stock_id, timestamp);


-- Partitioning
-- Create Partitioned stock_prices Table
-- Create the parent partitioned table
DROP TABLE IF EXISTS stock_prices CASCADE;

CREATE TABLE stock_prices (
    price_id SERIAL,
    stock_id INTEGER NOT NULL,
    price DECIMAL(10, 2) NOT NULL,
    timestamp TIMESTAMP NOT NULL,
    PRIMARY KEY (price_id, timestamp)
) PARTITION BY RANGE (timestamp);

-- Monthly partitions
CREATE TABLE stock_prices_2025_01 PARTITION OF stock_prices
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

CREATE TABLE stock_prices_2025_02 PARTITION OF stock_prices
FOR VALUES FROM ('2025-02-01') TO ('2025-03-01');

CREATE TABLE stock_prices_2025_03 PARTITION OF stock_prices
FOR VALUES FROM ('2025-03-01') TO ('2025-04-01');

-- Partitioned transactions Table
-- Create the parent partitioned table
DROP TABLE IF EXISTS transactions CASCADE;

CREATE TABLE transactions (
    transaction_id SERIAL,
    user_id INTEGER NOT NULL,
    stock_id INTEGER NOT NULL,
    transaction_type VARCHAR(10) NOT NULL CHECK (transaction_type IN ('BUY', 'SELL')),
    quantity INTEGER NOT NULL CHECK (quantity > 0),
    price DECIMAL(10, 2) NOT NULL,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (transaction_id, timestamp)
) PARTITION BY RANGE (timestamp);


-- quarterly partitions
CREATE TABLE transactions_2025_q1 PARTITION OF transactions
FOR VALUES FROM ('2025-01-01') TO ('2025-04-01');

CREATE TABLE transactions_2025_q2 PARTITION OF transactions
FOR VALUES FROM ('2025-04-01') TO ('2025-07-01');

CREATE TABLE transactions_2025_q3 PARTITION OF transactions
FOR VALUES FROM ('2025-07-01') TO ('2025-10-01');

CREATE TABLE transactions_2025_q4 PARTITION OF transactions
FOR VALUES FROM ('2025-10-01') TO ('2026-01-01');


